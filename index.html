<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search with Debug</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '1040996601945-vl54iod6107b32erjld001c0lh1r94t7.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBtc90LkMjXkFE80-NinZmBUHeD6Fn0sVI';
    const SCOPES = 'https://www.googleapis.com/auth/youtube.readonly';

    // Debug logger
    const Logger = {
      debug: function(message, data = null) {
        const logElement = document.getElementById('debug-log');
        const timestamp = new Date().toISOString();
        const logMessage = `${timestamp} - DEBUG: ${message}`;
        
        console.log(logMessage);
        if (data) console.log('Data:', data);
        
        if (logElement) {
          const entry = document.createElement('div');
          entry.className = 'log-entry debug';
          entry.textContent = logMessage;
          logElement.prepend(entry);
          if (data) {
            const dataEntry = document.createElement('div');
            dataEntry.className = 'log-data';
            dataEntry.textContent = JSON.stringify(data, null, 2);
            logElement.prepend(dataEntry);
          }
        }
      },
      
      error: function(message, error = null) {
        const logElement = document.getElementById('debug-log');
        const timestamp = new Date().toISOString();
        const logMessage = `${timestamp} - ERROR: ${message}`;
        
        console.error(logMessage);
        if (error) console.error('Error details:', error);
        
        if (logElement) {
          const entry = document.createElement('div');
          entry.className = 'log-entry error';
          entry.textContent = logMessage;
          logElement.prepend(entry);
          if (error) {
            const errorEntry = document.createElement('div');
            errorEntry.className = 'log-data error';
            errorEntry.textContent = error.stack || JSON.stringify(error, null, 2);
            logElement.prepend(errorEntry);
          }
        }
      }
    };

    // Authentication state checker
    function checkAuthState() {
      Logger.debug('Checking authentication state...');
      try {
        const authInstance = gapi.auth2.getAuthInstance();
        const isSignedIn = authInstance.isSignedIn.get();
        Logger.debug(`User is signed in: ${isSignedIn}`);
        return isSignedIn;
      } catch (error) {
        Logger.error('Error checking auth state:', error);
        return false;
      }
    }

    async function handleClientLoad() {
      Logger.debug('Starting client load...');
      try {
        gapi.load('client:auth2', initClient);
      } catch (error) {
        Logger.error('Error loading GAPI client:', error);
      }
    }

    async function initClient() {
      Logger.debug('Initializing client...');
      try {
        await gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"]
        });
        
        Logger.debug('Client initialized successfully');
        
        // Listen for sign-in state changes
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        
        // Handle initial sign-in state
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      } catch (error) {
        Logger.error('Error initializing client:', error);
        document.getElementById('status').innerHTML = 'Error initializing client. Check debug log.';
      }
    }

    function updateSigninStatus(isSignedIn) {
      Logger.debug(`Sign-in status changed. Is signed in: ${isSignedIn}`);
      document.getElementById('status').innerHTML = isSignedIn ? 
        'Signed in successfully' : 
        'Not signed in';
        
      if (!isSignedIn) {
        try {
          gapi.auth2.getAuthInstance().signIn();
        } catch (error) {
          Logger.error('Error during sign in:', error);
        }
      }
    }

    async function searchVideos() {
      Logger.debug('Starting video search...');
      
      // Check auth state first
      if (!checkAuthState()) {
        Logger.error('User not authenticated');
        document.getElementById('status').innerHTML = 'Please sign in first';
        return;
      }

      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        Logger.debug('Empty search query');
        alert('Please enter a search term!');
        return;
      }

      try {
        Logger.debug(`Searching for: ${query}`);
        document.getElementById('status').innerHTML = 'Searching...';

        const response = await gapi.client.youtube.search.list({
          part: 'snippet',
          q: query,
          type: 'video',
          maxResults: 10
        });

        Logger.debug('Search response received', response);

        if (response.result.items && response.result.items.length > 0) {
          displayResults(response.result.items);
          document.getElementById('status').innerHTML = 'Search completed';
        } else {
          Logger.debug('No videos found');
          document.getElementById('results').innerHTML = '<p>No videos found.</p>';
          document.getElementById('status').innerHTML = 'No results found';
        }
      } catch (error) {
        Logger.error('Error searching videos:', error);
        document.getElementById('results').innerHTML = '<p>Error searching videos. Please check debug log.</p>';
        document.getElementById('status').innerHTML = 'Error occurred during search';
      }
    }

    function displayResults(videos) {
      Logger.debug(`Displaying ${videos.length} results`);
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      videos.forEach((video, index) => {
        try {
          const videoDiv = document.createElement('div');
          videoDiv.className = 'video-item';
          videoDiv.innerHTML = `
            <h3>${video.snippet.title}</h3>
            <iframe
              width="560"
              height="315"
              src="https://www.youtube.com/embed/${video.id.videoId}"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
            <p>Channel: ${video.snippet.channelTitle}</p>
            <p>${video.snippet.description}</p>
          `;
          resultsDiv.appendChild(videoDiv);
        } catch (error) {
          Logger.error(`Error displaying video ${index}:`, error);
        }
      });
    }

    function clearLogs() {
      document.getElementById('debug-log').innerHTML = '';
      Logger.debug('Logs cleared');
    }

    // Wait for DOM to load before adding event listeners
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('searchBtn').addEventListener('click', searchVideos);
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchVideos();
        }
      });
      document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
      
      Logger.debug('Event listeners initialized');
    });
  </script>
  <style>
    /* Previous styles remain the same */
    
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: #1a1a1a;
      color: #fff;
      padding: 10px;
      font-family: monospace;
      overflow-y: auto;
      z-index: 1000;
    }

    #debug-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 5px;
      background: #333;
    }

    #debug-log {
      height: calc(100% - 40px);
      overflow-y: auto;
      font-size: 12px;
    }

    .log-entry {
      padding: 2px 5px;
      border-left: 3px solid;
      margin: 2px 0;
    }

    .log-entry.debug {
      border-color: #4CAF50;
    }

    .log-entry.error {
      border-color: #f44336;
      color: #f44336;
    }

    .log-data {
      padding: 2px 5px 2px 20px;
      font-size: 11px;
      color: #888;
      white-space: pre-wrap;
    }

    .log-data.error {
      color: #ffcdd2;
    }

    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      background: #333;
      color: white;
      border-radius: 3px;
      font-size: 14px;
    }

    body {
      margin-bottom: 220px; /* Make room for debug panel */
    }
  </style>
</head>
<body onload="handleClientLoad()">
  <div class="container">
    <h1>YouTube Video Search</h1>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Enter video name">
      <button id="searchBtn">Search</button>
    </div>
    <div id="status">Initializing...</div>
    <div id="results"></div>
  </div>

  <div id="debug-panel">
    <div id="debug-controls">
      <h3>Debug Log</h3>
      <button id="clearLogsBtn">Clear Logs</button>
    </div>
    <div id="debug-log"></div>
  </div>
</body>
</html>
